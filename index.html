<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MEIN KALENDAR</title>

  <!-- Spartan Font -->
  <link href="https://fonts.googleapis.com/css2?family=Spartan:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bordeaux: #800020;
      --bordeaux-strong:#6b0018;
      --white:#ffffff;
      --black:#000000;
      --glass: rgba(255,255,255,0.10);
      --glass-dark: rgba(0,0,0,0.45);
      --radius: 12px;
      --shadow: 0 6px 20px rgba(0,0,0,0.18);
      --accent-trans: rgba(128,0,32,0.18);
    }

    [data-theme="dark"] {
      --bg: var(--black);
      --panel: var(--glass-dark);
      --text: #fff;
    }

    [data-theme="light"] {
      --bg: #f7f7f7;
      --panel: rgba(255,255,255,0.6);
      --text: #111;
    }

    html,body{
      height:100%;
      margin:0;
      padding:0;
      font-family: 'Spartan', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    body{
      background: url('hintergrund.jpg') center/cover no-repeat fixed;
      background-color: var(--bg, #f7f7f7);
      color: var(--text, #111);
      display:flex;
      flex-direction:column;
      align-items:center;
      min-height:100vh;
      transition: background-color .25s ease;
    }

    .app {
      width:95%;
      max-width:980px;
      margin-top:20px;
      margin-bottom:40px;
      display:grid;
      grid-template-columns: 1fr 360px;
      gap:18px;
    }

    header.app-header {
      grid-column: 1/3;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px;
      background:var(--panel);
      border-radius:14px;
      box-shadow:var(--shadow);
      border: 1px solid rgba(255,255,255,0.06);
      backdrop-filter: blur(6px);
    }

    header .title { font-size:18px; font-weight:700; letter-spacing:1px; color:var(--text); }

    .controls { display:flex; gap:10px; align-items:center; }

    .control-btn {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.08);
      padding:8px 12px;
      border-radius:10px;
      color:var(--text);
      cursor:pointer;
      font-weight:600;
    }

    .calendar-card {
      background:var(--panel);
      border-radius:14px;
      padding:14px;
      box-shadow:var(--shadow);
      min-height:420px;
      display:flex;
      flex-direction:column;
      gap:12px;
      border: 1px solid rgba(0,0,0,0.04);
    }

    .month-header { display:flex; justify-content:space-between; align-items:center; }

    .month-title { font-size:18px; font-weight:700; color:var(--text); }

    .nav-btn {
      background:transparent;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.06);
      padding:6px 10px;
      cursor:pointer;
      color:var(--text);
    }

    .calendar-grid {
      display:grid;
      grid-template-columns: repeat(7,1fr);
      gap:8px;
    }

    .day {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:10px;
      padding:8px;
      min-height:90px;
      position:relative;
      border: 1px solid rgba(255,255,255,0.06);
      color:var(--text);
      display:flex;
      flex-direction:column;
      gap:6px;
      transition: transform .12s ease;
    }

    .day:hover { transform: translateY(-4px); }

    .day .date-num { font-size:13px; font-weight:700; }

    .event-pill {
      margin-top:auto;
      padding:6px 8px;
      border-radius:10px;
      font-size:12px;
      background: rgba(255,255,255,0.06);
      color:var(--text);
      border-left:6px solid rgba(255,255,255,0.08);
      display:flex;
      justify-content:space-between;
      gap:6px;
      align-items:center;
      position:relative;
    }

    .event-pill .gc-link {
      font-size:12px;
      color:var(--bordeaux);
      cursor:pointer;
      margin-left:4px;
      text-decoration:none;
    }

    .type-default { border-left-color: rgba(255,255,255,0.08); }
    .type-private { border-left-color: #d32f2f; }
    .type-work    { border-left-color: #2e7d32; }

    .side-card {
      background:var(--panel);
      border-radius:14px;
      padding:12px;
      box-shadow:var(--shadow);
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .input-row { display:flex; gap:8px; align-items:center; }

    .input-row input[type="text"]{
      flex:1;
      padding:10px 12px;
      border-radius:10px;
      border: none;
      outline:none;
      background: rgba(255,255,255,0.03);
      color:var(--text);
      font-weight:600;
    }

    .small-select {
      padding:8px 10px;
      background: transparent;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.06);
      color:var(--text);
      font-weight:600;
    }

    .icon-btn {
      padding:8px 10px;
      border-radius:10px;
      background:var(--bordeaux);
      color:var(--white);
      border:none;
      cursor:pointer;
      font-weight:700;
    }

    .weeks-list {
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height:420px;
      overflow:auto;
    }

    .week-item {
      border-radius:10px;
      padding:10px;
      background: rgba(255,255,255,0.02);
      display:flex;
      flex-direction:column;
      gap:8px;
      border:1px solid rgba(255,255,255,0.03);
    }

    .week-title {
      font-weight:700;
      color:var(--text);
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    .event-row {
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:6px 8px;
      border-radius:8px;
      background: rgba(255,255,255,0.01);
      align-items:center;
      border-left: 6px solid rgba(255,255,255,0.03);
    }

    .event-row.private { border-left-color: #d32f2f; }
    .event-row.work    { border-left-color: #2e7d32; }
    .event-row.default { border-left-color: rgba(255,255,255,0.06); }

    .tiny-muted { font-size:12px; opacity:0.7; }

    @media (max-width:980px){
      .app { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body data-theme="light">

  <div class="app">
    <header class="app-header">
      <div class="title">MEIN KALENDAR</div>
      <div class="controls">
        <button id="themeToggle" class="control-btn">ðŸŒ™ / â˜€</button>
        <button id="pushToggle" class="control-btn">ðŸ””</button>
      </div>
    </header>

    <!-- calendar left -->
    <section class="calendar-card" id="calendarCard">
      <div class="month-header">
        <button class="nav-btn" id="prevMonth">â—€</button>
        <div class="month-title" id="monthTitle">Oktober 2025</div>
        <button class="nav-btn" id="nextMonth">â–¶</button>
      </div>

      <div class="calendar-grid" id="calendarGrid"></div>
    </section>

    <!-- right: input & weeks -->
    <aside class="side-card">
      <div>
        <div class="input-row">
          <input id="freeInput" type="text" placeholder="z.B. 20/10/2025 20-22 Love is Blind mit ...">
          <select id="typeSelect" class="small-select">
            <option value="default">Standard</option>
            <option value="private">Privat</option>
            <option value="work">Arbeit</option>
          </select>
          <button id="micBtn" class="icon-btn" title="Sprache (spÃ¤ter) ðŸŽ™">ðŸŽ™</button>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px;">
          <button id="addEventBtn" class="icon-btn" style="background:var(--bordeaux)">+</button>
          <button id="clearBtn" class="control-btn">Clear</button>
        </div>
      </div>

      <div>
        <div style="font-weight:700;margin-bottom:8px;">Kommende Wochen</div>
        <div class="weeks-list" id="weeksList"></div>
      </div>
    </aside>
  </div>

<script>
const STORAGE_KEY = 'mein_kalender_events_v2';
let events = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
let viewDate = new Date();

document.addEventListener('DOMContentLoaded', () => {
  renderMonth(viewDate);
  renderWeeks();
  updateMonthTitle();
});

document.getElementById('themeToggle').addEventListener('click', () => {
  const body = document.body;
  const newTheme = body.dataset.theme === 'light' ? 'dark' : 'light';
  body.dataset.theme = newTheme;
  document.body.style.backgroundColor = (newTheme==='dark')?'#000':'';
});

document.getElementById('prevMonth').addEventListener('click', ()=>{ changeMonth(-1); });
document.getElementById('nextMonth').addEventListener('click', ()=>{ changeMonth(1); });

function changeMonth(offset){
  viewDate.setMonth(viewDate.getMonth() + offset);
  renderMonth(viewDate);
  updateMonthTitle();
}

document.getElementById('addEventBtn').addEventListener('click', () => {
  const raw = document.getElementById('freeInput').value.trim();
  const type = document.getElementById('typeSelect').value;
  if(!raw) return alert('Bitte Text eingeben (Datum + Beschreibung).');

  const parsedEvents = parseInputToEvent(raw, type);
  if(!parsedEvents || parsedEvents.length===0){
    return alert('Datum/Uhrzeit konnte nicht erkannt werden.');
  }

  events.push(...parsedEvents);
  saveEvents();
  document.getElementById('freeInput').value = '';
  renderMonth(viewDate);
  renderWeeks();
});

document.getElementById('clearBtn').addEventListener('click', ()=>{
  if(confirm('Alle Events lÃ¶schen?')) {
    events=[];
    saveEvents();
    renderMonth(viewDate);
    renderWeeks();
  }
});

function saveEvents(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(events)); }

function updateMonthTitle(){
  const monthNames = ["Januar","Februar","MÃ¤rz","April","Mai","Juni","Juli","August","September","Oktober","November","Dezember"];
  document.getElementById('monthTitle').textContent = `${monthNames[viewDate.getMonth()]} ${viewDate.getFullYear()}`;
}

function renderMonth(date){
  const grid = document.getElementById('calendarGrid');
  grid.innerHTML='';

  const year=date.getFullYear(), month=date.getMonth();
  const first=new Date(year,month,1);
  const startDay=(first.getDay()+6)%7;
  const daysInMonth=new Date(year,month+1,0).getDate();

  for(let i=0;i<startDay;i++){ const d=document.createElement('div'); d.className='day'; d.style.opacity=0.5; grid.appendChild(d); }

  for(let day=1;day<=daysInMonth;day++){
    const cellDate=new Date(year,month,day);
    const cell=document.createElement('div'); cell.className='day';
    const dateNum=document.createElement('div'); dateNum.className='date-num'; dateNum.textContent=day; cell.appendChild(dateNum);

    const iso=formatYMD(cellDate);
    const dayEvents=events.filter(e=>e.date===iso).sort((a,b)=> timeToMinutes(a.startTime)-timeToMinutes(b.startTime));

    if(dayEvents.length){
      dayEvents.slice(0,2).forEach(ev=>{
        const pill=document.createElement('div');
        pill.className='event-pill '+(ev.type==='private'?'type-private':(ev.type==='work'?'type-work':'type-default'));
        pill.innerHTML=`<div style="font-size:12px;font-weight:700;">${ev.title}</div><a class="gc-link" title="Google Kalender Ã¶ffnen" href="${generateGoogleCalendarUrl(ev)}" target="_blank">ðŸ“…</a>`;
        cell.appendChild(pill);
      });
      if(dayEvents.length>2){
        const more=document.createElement('div'); more.className='tiny-muted'; more.style.marginTop='6px'; more.textContent=`+${dayEvents.length-2} weitere`; cell.appendChild(more);
      }
    }

    if(dayEvents.some(e=>e.type==='private')) cell.style.border='2px solid #d32f2f';
    else if(dayEvents.some(e=>e.type==='work')) cell.style.border='2px solid #2e7d32';
    else if(dayEvents.length>0) cell.style.border='2px solid rgba(255,255,255,0.06)';
    else cell.style.border='1px solid rgba(255,255,255,0.04)';

    grid.appendChild(cell);
  }
}

function renderWeeks(){
  const container=document.getElementById('weeksList'); container.innerHTML='';
  const today=startOfDay(new Date());
  const weeks=[];

  for(let w=0;w<8;w++){
    const start=addDays(startOfWeek(today), w*7);
    const end=addDays(start,6);
    const evs=events.filter(e=>{ const d=parseYMD(e.date); return d>=start && d<=end; }).sort((a,b)=> new Date(a.date+'T'+(a.startTime||'00:00')) - new Date(b.date+'T'+(b.startTime||'00:00')));
    if(evs.length>0) weeks.push({start,end,events:evs});
  }

  weeks.forEach(wk=>{
    const item=document.createElement('div'); item.className='week-item';
    const title=document.createElement('div'); title.className='week-title';
    title.innerHTML=`<div>${formatShort(wk.start)} â€” ${formatShort(wk.end)}</div><div class="tiny-muted">${wk.events.length} Termine</div>`;
    item.appendChild(title);
    wk.events.forEach(ev=>{
      const row=document.createElement('div');
      row.className='event-row '+(ev.type==='private'?'private':(ev.type==='work'?'work':'default'));
      row.innerHTML=`<div style="font-weight:700">${ev.title}</div><div class="tiny-muted">${formatDayTime(ev.date, ev.startTime)}</div>`;
      row.addEventListener('click',()=>{ window.open(generateGoogleCalendarUrl(ev),'_blank'); });
      item.appendChild(row);
    });
    container.appendChild(item);
  });

  if(weeks.length===0) container.innerHTML=`<div class="tiny-muted">Keine kommenden Termine.</div>`;
}

/* -------------------------
  Parsing with recurrence
-------------------------*/
function parseInputToEvent(text,type='default'){
  const eventsList=[];
  let t=text.trim();
  let recurrenceMatch=t.match(/every\s+(\d+)\s+(days|weeks|months)/i);
  let recurrence=null;
  if(recurrenceMatch){
    recurrence={interval:parseInt(recurrenceMatch[1],10),unit:recurrenceMatch[2].toLowerCase()};
    t=t.replace(recurrenceMatch[0],'').trim();
  }

  const singleEvent=parseSingleEvent(t,type);
  eventsList.push(singleEvent);

  if(recurrence){
    for(let i=1;i<5;i++){ // 4 future occurrences for demo
      const d=new Date(singleEvent.date);
      if(recurrence.unit==='days') d.setDate(d.getDate()+i*recurrence.interval);
      if(recurrence.unit==='weeks') d.setDate(d.getDate()+i*7*recurrence.interval);
      if(recurrence.unit==='months') d.setMonth(d.getMonth()+i*recurrence.interval);
      eventsList.push({...singleEvent,date:formatYMD(d),id:'ev_'+Math.random().toString(36).slice(2,9)});
    }
  }

  return eventsList;
}

function parseSingleEvent(text,type){
  let t=text.trim();
  let startTime='',endTime='';
  const timeMatch=t.match(/(\d{1,2}[:.]?\d{0,2})\s*[-â€“]\s*(\d{1,2}[:.]?\d{0,2})/);
  if(timeMatch){ startTime=normalizeTime(timeMatch[1]); endTime=normalizeTime(timeMatch[2]); t=t.replace(timeMatch[0],'').trim(); }
  else { const around=t.match(/um\s+(\d{1,2}[:.]?\d{0,2})/i); if(around){ startTime=normalizeTime(around[1]); endTime=addHourToTime(startTime,1); t=t.replace(around[0],'').trim(); } }

  let date=null;
  const dateMatch=t.match(/(\d{1,2}[.\/]\d{1,2}[.\/]\d{2,4})/);
  if(dateMatch){ date=parseDateString(dateMatch[1]); t=t.replace(dateMatch[0],'').trim(); }
  else if(/\bheute\b/i.test(t)){ date=new Date(); t=t.replace(/\bheute\b/i,'').trim(); }
  else if(/\bmorgen\b/i.test(t)){ date=addDays(new Date(),1); t=t.replace(/\bmorgen\b/i,'').trim(); }
  else { const inDays=t.match(/in\s+(\d{1,2})\s+tage?n?/i); if(inDays){ date=addDays(new Date(),parseInt(inDays[1],10)); t=t.replace(inDays[0],'').trim(); } }

  if(!date) date=new Date();
  const title=t||'Termin';
  return {id:'ev_'+Math.random().toString(36).slice(2,9),date:formatYMD(date),title,startTime,endTime,type};
}

/* -------------------------
  Helper functions
-------------------------*/
function formatYMD(d){ const dt=new Date(d); return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}`; }
function parseYMD(s){ const [y,m,d]=s.split('-').map(Number); return new Date(y,m-1,d); }
function formatShort(d){ const dd=new Date(d); return `${String(dd.getDate()).padStart(2,'0')}.${String(dd.getMonth()+1).padStart(2,'0')}.${dd.getFullYear()}`; }
function formatDayTime(dateStr,timeStr){ const d=new Date(dateStr); const day=d.toLocaleDateString('de-DE',{weekday:'short',day:'2-digit',month:'short'}); return timeStr?`${day} â€¢ ${timeStr}`:day; }
function startOfDay(d){ const x=new Date(d); x.setHours(0,0,0,0); return x; }
function startOfWeek(d){ const x=new Date(d); const day=x.getDay()||7; x.setDate(x.getDate()-day+1); return startOfDay(x); }
function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
function timeToMinutes(t){ if(!t) return 0; const [hh,mm]=t.split(':').map(Number); return hh*60+mm; }
function parseDateString(s){ const cleaned=s.replace(/\./g,'/'); const parts=cleaned.split('/'); if(parts.length===3){ let d=parseInt(parts[0],10), m=parseInt(parts[1],10), y=parseInt(parts[2],10); if(y<100) y+=2000; return new Date(y,m-1,d);} return null; }
function normalizeTime(t){ const cleaned=t.replace('.',':'); if(/^\d{1,2}$/.test(cleaned)) return cleaned.padStart(2,'0')+':00'; if(/^\d{1,2}:\d{1,2}$/.test(cleaned)){ const [hh,mm]=cleaned.split(':'); return hh.padStart(2,'0')+':'+mm.padStart(2,'0'); } return ''; }
function addHourToTime(t,h){ if(!t) return ''; const [hh,mm]=t.split(':').map(Number); const d=new Date(); d.setHours(hh+h, mm||0,0,0); return String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0'); }

function generateGoogleCalendarUrl(ev){
  const formatForUrl=(s)=>s.replace(/[-:]/g,'')+'Z';
  const startStr=formatForUrl(ev.date+'T'+(ev.startTime?ev.startTime.replace(':','')+'00':'000000'));
  const endStr=formatForUrl(ev.date+'T'+(ev.endTime?ev.endTime.replace(':','')+'00':'010000'));
  const text=encodeURIComponent(ev.title);
  const details=encodeURIComponent('Erstellt via MEIN KALENDAR');
  return `https://www.google.com/calendar/render?action=TEMPLATE&text=${text}&dates=${startStr}/${endStr}&details=${details}`;
}
</script>
</body>
</html>


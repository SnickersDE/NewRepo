<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mein Kalender</title>
  <link rel="manifest" href="manifest.json">
  <style>
    :root {
      --bordeaux: #7b1e3a;
      --white: #ffffff;
      --dark: #000000;
      --light-glass: rgba(255, 255, 255, 0.2);
      --dark-glass: rgba(0, 0, 0, 0.5);
    }

    body {
      font-family: 'Spartan', sans-serif;
      text-transform: uppercase;
      margin: 0;
      background: url('hintergrund.jpg') no-repeat center center/cover;
      color: #222;
      backdrop-filter: blur(6px);
      transition: background 0.3s, color 0.3s;
    }

    body[data-theme="dark"] {
      background-color: var(--dark);
      color: #fff;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background: var(--light-glass);
      backdrop-filter: blur(10px);
      border-bottom: 2px solid var(--bordeaux);
    }

    .controls {
      display: flex;
      gap: 1rem;
    }

    .toggle-btn {
      background: var(--bordeaux);
      color: var(--white);
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
      transition: 0.3s;
    }

    main {
      padding: 1rem;
    }

    #calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      background: var(--light-glass);
      border-radius: 15px;
      padding: 1rem;
      text-align: center;
      margin-bottom: 1rem;
      backdrop-filter: blur(10px);
    }

    .day {
      border: 2px solid rgba(255, 255, 255, 0.4);
      border-radius: 12px;
      padding: 10px;
      cursor: pointer;
      transition: 0.2s;
      background-color: rgba(255,255,255,0.1);
    }

    .day:hover {
      background-color: rgba(255,255,255,0.25);
    }

    .day.private { border-color: #c0392b; background-color: rgba(192,57,43,0.15); }
    .day.work { border-color: #27ae60; background-color: rgba(39,174,96,0.15); }

    #weeks {
      margin-top: 1rem;
    }

    .week {
      background: var(--light-glass);
      border-radius: 10px;
      margin-bottom: 0.5rem;
      overflow: hidden;
    }

    .week-header {
      background: var(--bordeaux);
      color: var(--white);
      padding: 0.5rem;
      cursor: pointer;
      text-align: left;
    }

    .week-content {
      display: none;
      padding: 0.5rem 1rem;
    }

    .week-content.active {
      display: block;
    }

    .input-area {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 1rem;
      background: var(--light-glass);
      padding: 0.5rem;
      border-radius: 10px;
      backdrop-filter: blur(8px);
    }

    input[type="text"] {
      flex: 1;
      background: transparent;
      border: none;
      color: inherit;
      outline: none;
      font-size: 1rem;
    }

    .mic-btn, .send-btn, .clear-btn {
      background: var(--bordeaux);
      color: var(--white);
      border: none;
      padding: 0.5rem 0.7rem;
      border-radius: 10px;
      cursor: pointer;
    }

    .send-btn:hover, .mic-btn:hover, .clear-btn:hover {
      opacity: 0.8;
    }

    .calendar-add {
      cursor: pointer;
      color: var(--bordeaux);
      font-size: 1.2rem;
      margin-left: 0.5rem;
    }
  </style>
</head>

<body data-theme="light">
  <header>
    <h1>Mein Kalender</h1>
    <div class="controls">
      <button class="toggle-btn" id="themeToggle">☀ / 🌙</button>
      <button class="toggle-btn" id="notifToggle">🔔</button>
      <button class="toggle-btn clear-btn" id="clearBtn">Clear</button>
    </div>
  </header>

  <main>
    <!-- === Monats-Header mit Navigation === -->
<div id="calendarHeader" style="display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:8px;">
  <button id="prevMonth" class="control-btn" aria-label="Vorheriger Monat">◀</button>
  <div id="monthTitle" style="font-weight:700; font-size:1.05rem; text-align:center;"></div>
  <button id="nextMonth" class="control-btn" aria-label="Nächster Monat">▶</button>
</div>

<!-- Hier bleibt das Grid -->
<div id="calendar"></div>

    <div class="input-area">
      <input id="inputText" type="text" placeholder="Neuen Termin eingeben... (z. B. 'Morgen 14 Uhr Meeting')">
      <button class="mic-btn">🎙</button>
      <button class="send-btn" id="sendBtn">➤</button>
    </div>
  </main>

  <script>
    /* -----------------------------
  Monatsanzeige + Navigation
  + Wochenüberschriften mit vollem Zeitraum
   - Einfaches Drop-in: ersetzt die alte renderMonth / renderWeeks Logik
------------------------------*/

const calendar = document.getElementById('calendar');
const monthTitleEl = document.getElementById('monthTitle');
const prevMonthBtn = document.getElementById('prevMonth');
const nextMonthBtn = document.getElementById('nextMonth');

// Aktuelle Ansicht (Monat/Jahr) initialisieren
let viewDate = new Date(); // zeigt aktuellen Monat

// Event-Listener für Nav-Buttons
prevMonthBtn && prevMonthBtn.addEventListener('click', () => { changeMonth(-1); });
nextMonthBtn && nextMonthBtn.addEventListener('click', () => { changeMonth(1); });

function changeMonth(offset){
  viewDate.setMonth(viewDate.getMonth() + offset);
  renderCalendar();   // rendert Grid neu
  markDays();         // markiert Tage mit Events neu
}

// Month Title (z. B. "Oktober 2025")
function updateMonthTitle(){
  const monthNames = ["Januar","Februar","März","April","Mai","Juni","Juli","August","September","Oktober","November","Dezember"];
  monthTitleEl.textContent = `${monthNames[viewDate.getMonth()]} ${viewDate.getFullYear()}`;
}

// Rendert das Grid (Monatsansicht) für viewDate
function renderCalendar(){
  calendar.innerHTML = '';
  updateMonthTitle();

  const year = viewDate.getFullYear();
  const month = viewDate.getMonth();

  // erster Tag des Monats
  const first = new Date(year, month, 1);
  // Anzahl leerer Zellen vor dem 1. (Montag-basiert)
  const leadingEmpty = (first.getDay() + 6) % 7; // konvertiert JS Sun=0 -> index

  const daysInMonth = new Date(year, month + 1, 0).getDate();

  // leere Zellen
  for(let i=0; i<leadingEmpty; i++){
    const empty = document.createElement('div');
    empty.className = 'day empty';
    calendar.appendChild(empty);
  }

  // Tage
  for(let d=1; d<=daysInMonth; d++){
    const cellDate = new Date(year, month, d);
    const cell = document.createElement('div');
    cell.className = 'day';
    cell.dataset.day = d; // handy für Markierung
    // Datum-Nummer
    const dateNum = document.createElement('div');
    dateNum.className = 'date-num';
    dateNum.textContent = d;
    cell.appendChild(dateNum);
    calendar.appendChild(cell);
  }

  // nach rendern: markiere Tage mit Events
  markDays();
}

// markiert Tage (Events) im aktuell sichtbaren Monat
function markDays(){
  // entferne alte Markierungen / Pills
  calendar.querySelectorAll('.day').forEach(c => {
    // lösche event-bezogene Klassen und Zusatzknoten
    c.classList.remove('private','work','has-event');
    c.querySelectorAll('.event-pill, .span-pill').forEach(n => n.remove());
  });

  // Gehe alle Events durch und markiere Zellen innerhalb dieses Monats
  events.forEach(ev => {
    // event.start und ev.end ggf. nutzen
    const start = parseYMD(ev.date);
    const end = ev.endDate ? parseYMD(ev.endDate) : start;

    // für jeden Tag im Event-Zeitraum
    for(let d = new Date(start); d <= end; d.setDate(d.getDate()+1)){
      if(d.getFullYear() === viewDate.getFullYear() && d.getMonth() === viewDate.getMonth()){
        const cell = calendar.querySelector(`.day[data-day='${d.getDate()}']`);
        if(!cell) continue;
        // setze Typ-Klasse
        if(ev.type === 'private') cell.classList.add('private');
        else if(ev.type === 'work') cell.classList.add('work');

        // wenn Event mehrtägig (endDate existiert) -> span-pill (leichter Fill)
        if(ev.endDate){
          const span = document.createElement('div');
          span.className = 'span-pill ' + (ev.type === 'private' ? 'type-private' : ev.type === 'work' ? 'type-work' : 'type-default');
          span.textContent = ev.title.length > 22 ? ev.title.slice(0,20) + '…' : ev.title;
          cell.appendChild(span);
        } else {
          // Ein-Tages-Event: event-pill mit Zeit
          const pill = document.createElement('div');
          pill.className = 'event-pill ' + (ev.type === 'private' ? 'type-private' : ev.type === 'work' ? 'type-work' : 'type-default');
          pill.innerHTML = `<div style="font-size:12px; font-weight:700;">${ev.title.length>18?ev.title.slice(0,16)+'…':ev.title}</div><div class="tiny-muted" style="font-size:11px">${ev.startTime||''}</div>`;
          cell.appendChild(pill);
        }
      }
    }
  });
}

/* --------------------------
  Wochenliste: komplette Woche anzeigen (Start - Ende)
---------------------------*/
function renderWeeks(){
  const container = document.getElementById('weeksList') || document.getElementById('weeks');

  if(!container) return;
  container.innerHTML = '';

  const today = startOfDay(new Date());
  const weeksWithEvents = [];

  // prüfe die nächsten 12 Wochen (konfigurierbar)
  for(let w=0; w<12; w++){
    const start = addDays(startOfWeek(today), w*7);
    const end = addDays(start, 6);

    // finde Events in diesem Zeitraum
    const evs = events.filter(e => {
      const d = parseYMD(e.date);
      const sCmp = startOfDay(d);
      return sCmp >= start && sCmp <= end;
    }).sort((a,b) => {
      const da = new Date(a.date + 'T' + (a.startTime || '00:00'));
      const db = new Date(b.date + 'T' + (b.startTime || '00:00'));
      return da - db;
    });

    if(evs.length) weeksWithEvents.push({ start, end, events: evs });
  }

  if(weeksWithEvents.length === 0){
    container.innerHTML = `<div class="tiny-muted">Keine kommenden Termine.</div>`;
    return;
  }

  weeksWithEvents.forEach(wk => {
    const item = document.createElement('div');
    item.className = 'week-item';

    const title = document.createElement('div');
    title.className = 'week-title';
    title.innerHTML = `<div>${formatRange(wk.start, wk.end)}</div><div class="tiny-muted">${wk.events.length} Termine</div>`;
    item.appendChild(title);

    wk.events.forEach(ev => {
      const row = document.createElement('div');
      row.className = 'event-row ' + (ev.type === 'private' ? 'private' : (ev.type === 'work' ? 'work' : 'default'));

      const left = document.createElement('div');
      left.style.display = 'flex';
      left.style.flexDirection = 'column';
      left.innerHTML = `<div style="font-weight:700">${ev.title}</div><div class="tiny-muted">${formatDayTime(ev.date, ev.startTime)}</div>`;

      const right = document.createElement('div');
      right.style.display = 'flex';
      right.style.gap = '8px';

      const sendBtn = document.createElement('button');
      sendBtn.className = 'send-icon';
      sendBtn.title = 'An Google Kalender senden';
      sendBtn.innerHTML = '📤';
      sendBtn.dataset.id = ev.id;
      sendBtn.addEventListener('click', (evClick) => {
        evClick.stopPropagation();
        const id = evClick.currentTarget.dataset.id;
        const eventObj = events.find(x => x.id === id);
        if(eventObj) window.open(generateGoogleCalendarUrl(eventObj), '_blank');
      });

      const delBtn = document.createElement('button');
      delBtn.className = 'delete-icon';
      delBtn.title = 'Termin löschen';
      delBtn.innerHTML = '🗑️';
      delBtn.dataset.id = ev.id;
      delBtn.addEventListener('click', (eClick) => {
        eClick.stopPropagation();
        const id = eClick.currentTarget.dataset.id;
        if(confirm('Termin löschen?')){
          events = events.filter(x => x.id !== id);
          saveEvents();
          renderCalendar();
          renderWeeks();
        }
      });

      right.appendChild(sendBtn);
      right.appendChild(delBtn);

      row.appendChild(left);
      row.appendChild(right);

      item.appendChild(row);
    });

    container.appendChild(item);
  });
}

/* -------------------------
  Hilfsfunktionen (falls noch nicht vorhanden)
--------------------------*/
function startOfDay(d){
  const x = new Date(d);
  x.setHours(0,0,0,0);
  return x;
}

function startOfWeek(d){
  const x = new Date(d);
  const day = x.getDay(); // 0..6 (Sun..Sat)
  const diff = (day + 6) % 7; // Monday=0
  x.setDate(x.getDate() - diff);
  x.setHours(0,0,0,0);
  return x;
}

function addDays(d, n){
  const x = new Date(d);
  x.setDate(x.getDate() + n);
  x.setHours(0,0,0,0);
  return x;
}

function formatDDMMYYYY(d){
  const D = new Date(d);
  const dd = String(D.getDate()).padStart(2,'0');
  const mm = String(D.getMonth()+1).padStart(2,'0');
  const yyyy = D.getFullYear();
  return `${dd}.${mm}.${yyyy}`;
}

function formatRange(start, end){
  return `${formatDDMMYYYY(start)} - ${formatDDMMYYYY(end)}`;
}

function formatDayTime(dateStr, timeStr){
  const d = new Date(dateStr);
  const day = d.toLocaleDateString('de-DE',{weekday:'short', day:'2-digit', month:'short'});
  return timeStr ? `${day} • ${timeStr}` : `${day}`;
}

/* -------------------------
  Initial render (call this once on load)
---------------------------*/
renderCalendar();
renderWeeks();

    // === Basis Setup ===
    const themeToggle = document.getElementById('themeToggle');
    const notifToggle = document.getElementById('notifToggle');
    const clearBtn = document.getElementById('clearBtn');
    const calendar = document.getElementById('calendar');
    const weeksContainer = document.getElementById('weeks');
    const sendBtn = document.getElementById('sendBtn');
    const inputText = document.getElementById('inputText');

    let events = [];

    // === Kalender anzeigen ===
    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth();
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    for (let d = 1; d <= daysInMonth; d++) {
      const dayElem = document.createElement('div');
      dayElem.classList.add('day');
      dayElem.textContent = d;
      calendar.appendChild(dayElem);
    }

    // === Eingabe verarbeiten ===
    function parseInput(text) {
      const lower = text.toLowerCase();
      let date = new Date();
      let time = '00:00';
      let title = text;

      // Datumserkennung
      const dateMatch = text.match(/(\d{1,2})\.(\d{1,2})/);
      if (dateMatch) {
        const day = parseInt(dateMatch[1]);
        const month = parseInt(dateMatch[2]) - 1;
        date = new Date(year, month, day);
      } else if (lower.includes('morgen')) {
        date.setDate(date.getDate() + 1);
      } else if (lower.includes('übermorgen')) {
        date.setDate(date.getDate() + 2);
      } else if (lower.includes('nächste woche')) {
        date.setDate(date.getDate() + 7);
      }

      // Uhrzeit-Erkennung
      const timeMatch = text.match(/(\d{1,2})[:\.](\d{2})/);
      if (timeMatch) {
        time = `${timeMatch[1].padStart(2,'0')}:${timeMatch[2]}`;
      } else {
        const hourMatch = text.match(/(\d{1,2})\s*uhr/);
        if (hourMatch) time = `${hourMatch[1].padStart(2,'0')}:00`;
      }

      // Farbcode (private/work)
      const type = lower.includes('arbeit') ? 'work' : 'private';

      return { title, date, time, type };
    }

    function addEvent(event) {
      events.push(event);
      renderEvents();
    }

    function renderEvents() {
      // Sortieren nach Datum & Zeit
      events.sort((a,b) => a.date - b.date || a.time.localeCompare(b.time));
      weeksContainer.innerHTML = '';

      const grouped = {};
      for (const e of events) {
        const weekStart = new Date(e.date);
        const startOfWeek = new Date(weekStart.setDate(e.date.getDate() - e.date.getDay() + 1));
        const weekKey = `${startOfWeek.getDate()}.${startOfWeek.getMonth()+1}.${year}`;

        if (!grouped[weekKey]) grouped[weekKey] = [];
        grouped[weekKey].push(e);
      }

      for (const [week, evts] of Object.entries(grouped)) {
        const weekElem = document.createElement('div');
        weekElem.classList.add('week');

        const header = document.createElement('div');
        header.classList.add('week-header');
        header.textContent = `Woche ${week}`;
        header.addEventListener('click', () => {
          content.classList.toggle('active');
        });

        const content = document.createElement('div');
        content.classList.add('week-content');

        for (const e of evts) {
          const p = document.createElement('p');
          p.innerHTML = `${e.date.toLocaleDateString()} - ${e.time} ${e.title} <span class="calendar-add" title="Zu Google Kalender hinzufügen">📆</span>`;
          content.appendChild(p);

          // Markiere Tag im Kalender
          const dayElem = calendar.children[e.date.getDate() - 1];
          if (dayElem) dayElem.classList.add(e.type);
        }

        weekElem.appendChild(header);
        weekElem.appendChild(content);
        weeksContainer.appendChild(weekElem);
      }
    }

    sendBtn.addEventListener('click', () => {
      const text = inputText.value.trim();
      if (!text) return;
      const evt = parseInput(text);
      addEvent(evt);
      inputText.value = '';
    });

    // Clear-Funktion
    clearBtn.addEventListener('click', () => {
      events = [];
      renderEvents();
      calendar.querySelectorAll('.day').forEach(d => d.className = 'day');
    });

    // Dark Mode Toggle
    themeToggle.addEventListener('click', () => {
      const body = document.body;
      const newTheme = body.dataset.theme === 'light' ? 'dark' : 'light';
      body.dataset.theme = newTheme;
    });
  </script>
</body>
</html>

